package org.Macro;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import javax.inject.Named;

import org.Macro.common.OrderHandler;
import org.TRX.bwapi.Facade.GameListener;
import org.TRX.bwapi.Facade.Utils.BuildOrder;
import org.TRX.bwapi.Facade.manager.BuildingManager;
import org.TRX.bwapi.Facade.manager.WorkerManager;

import bwapi.Order;
import bwapi.Unit;
import bwapi.UnitType;

/**
 * Handels all the Macro In Starcraft Macro describes all of baseconstruction
 * handeling upgrades and exansions
 * 
 * @author Turox
 *
 */
@Named
public class BasicMacroManager {

	@Inject
	GameListener gameListener;

	@Inject
	WorkerManager workerManager;

	@Inject
	BuildingManager buildingManager;

	@Inject
	OrderHandler orderHandler;

	@Inject
	ProductionManager productionManager;

	private int lastCheckedOrders;

	@PostConstruct
	private void init() {
		this.lastCheckedOrders = 0;
	}

	public void update() {
		this.workerManager.update();
		this.productionManager.update();
		this.handelSupply();

		if (this.gameListener.getGame().getFrameCount() >= (this.lastCheckedOrders + 120)) {
			System.out.println(this.getAmountOfOrders(UnitType.Terran_Supply_Depot));
			this.updateOrders();
			this.lastCheckedOrders = this.gameListener.getGame().getFrameCount();
		}
	}

	private void handelSupply() {
		// System.out.println(this.getAmountOfOrders(UnitType.Terran_Supply_Depot));

		if (this.getAmountOfOrders(UnitType.Terran_Supply_Depot) < 1) {
			if ((this.gameListener.getSelf().supplyTotal() - this.gameListener.getSelf().supplyUsed() < 8)
					&& this.gameListener.getSelf().minerals() >= 100
					&& this.gameListener.getSelf().supplyUsed() < 400) {
				Unit myUnit = this.workerManager.getFreeWorker();
				this.buildingManager.buildBuilding(UnitType.Terran_Supply_Depot,
						this.gameListener.getSelf().getStartLocation(), myUnit);
				System.out.println("myUnit: " + myUnit);
				// MyUnit ist null spÃ¤ter irgendwie
				this.orderHandler.addOrder(
						new BuildOrder(gameListener.getGame().getFrameCount(), UnitType.Terran_Supply_Depot, myUnit));
			}
		}
	}

	

	private int getAmountOfOrders(UnitType unitType) {
		int result = 0;
		for (BuildOrder order : this.orderHandler.getCurrentOrders()) {
			if (order.getUnitType() == unitType) {
				result++;
			}
		}
		return result;
	}
}
